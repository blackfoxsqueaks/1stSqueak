<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Drop | Send a Signal</title>
    <link rel="manifest" href="manifest.json">

    <!-- Favicon and Touch Icons -->
    <meta name="apple-itunes-app" content="app-id=6746170335, app-argument=drop://" />
	<link rel="apple-touch-icon" sizes="60x60" href="https://drop-eg.com/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://drop-eg.com/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://drop-eg.com/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://drop-eg.com/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://drop-eg.com/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://drop-eg.com/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://drop-eg.com/icons/favicon-16x16.png">
    <link rel="manifest" href="https://drop-eg.com/icons/site.webmanifest">
    <link rel="mask-icon" href="https://drop-eg.com/icons/safari-pinned-tab.svg" color="#2667ff">
    <link rel="shortcut icon" href="https://drop-eg.com/icons/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="https://drop-eg.com/icons/browserconfig.xml">


    <!-- Open Graph / Facebook Meta Tags -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Drop App">
    <meta property="og:url" content="https://drop-eg.com">
    <meta property="og:title" content="Drop: Your All-In-One Car App in Egypt for Car Wash, Repairs, & More...">
    <meta property="og:description" content="Experience a seamless car ownership in Egypt! Enjoy car washes right at home with WashDrop in areas like New Cairo, Maadi, Madinaty, and beyond. Easily book appointments for repairs, maintenance, and customizations at top-notch car workshops and automotive service centers in Egypt. Plus, explore exciting features like Signals for seamless peer-to-peer communication and DropFM for music streaming while cruising through Cairo's streets. Whether you need a quick wash or comprehensive car services, Drop App is your ultimate solution for all your car needs in Egypt!">
    <meta property="og:image" content="open-graph/open-graph-banner.png">
    <meta property="og:logo" content="open-graph/drop-app-logo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="627">

<!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Drop: Your All-In-One Car App in Egypt for Car Wash, Repairs, & More...">
    <meta name="twitter:description" content="Experience a seamless car ownership in Egypt! Enjoy car washes right at home with WashDrop in areas like New Cairo, Maadi, Madinaty, and beyond. Easily book appointments for repairs, maintenance, and customizations at top-notch car workshops and automotive service centers in Egypt. Plus, explore exciting features like Signals for seamless peer-to-peer communication and DropFM for music streaming while cruising through Cairo's streets. Whether you need a quick wash or comprehensive car services, Drop App is your ultimate solution for all your car needs in Egypt!">
    <meta name="twitter:image" content="open-graph/open-graph-banner.png">

<!-- Google / Search Engine Tags -->
    <meta itemprop="name" content="Drop App">
    <meta itemprop="description" content="Experience a seamless car ownership in Egypt! Enjoy car washes right at home with WashDrop in areas like New Cairo, Maadi, Madinaty, and beyond. Easily book appointments for repairs, maintenance, and customizations at top-notch car workshops and automotive service centers in Egypt. Plus, explore exciting features like Signals for seamless peer-to-peer communication and DropFM for music streaming while cruising through Cairo's streets. Whether you need a quick wash or comprehensive car services, Drop App is your ultimate solution for all your car needs in Egypt!">
    <meta itemprop="image" content="open-graph/open-graph-banner.png">




    <!-- Theme Color -->
    <meta name="theme-color" content="#346df8" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#346df8" media="(prefers-color-scheme: dark)">


    <link rel="prerender" href="https://drop-eg.com/side-menu">
    <iframe src="https://drop-eg.com/side-menu" style="display:none;"></iframe>

    <style>

::-webkit-scrollbar {
  display: none;
}

        @font-face {
  font-family: 'RidleyGroteskBold';
  src: url("fonts/Ridley_Grotesk_Bold.woff") format("truetype");
    font-weight: Bold;
  font-style: normal;
}


@font-face {
  font-family: 'RidleyGroteskMedium';
  src: url("fonts/Ridley_Grotesk_Medium.woff") format("truetype");
}


@font-face {
  font-family: 'RidleyGroteskRegular';
  src: url("fonts/Ridley_Grotesk_Regular.woff") format("truetype");
    font-weight: normal;
  font-style: normal;
}

@font-face {
  font-family: 'HacenMaghrebBold';
  src: url("fonts/Hacen_Maghreb_Bold.woff") format("truetype");
    font-weight: normal;
  font-style: normal;
}

@font-face {
  font-family: 'HacenMaghrebRegular';
  src: url("https://drop-eg.com/fonts/Hacen_Lt.woff") format("truetype");
    font-weight: normal;
  font-style: normal;
}
        body {
    font-family: 'Arial, sans-serif';
    background-color: white;
    color: black;
    margin: 0;
    margin-right: -1px;
    padding: 0;
    overflow-x: hidden; /* Ensure no horizontal scrolling */
}

.appbar {
    width: 100%;
    text-align: center;
    padding: 0;
    height: 40px; /* Adjust the height based on your appbar design */
    background-color: #346df8; /* Example background color */
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1; /* Ensure appbar is on top of content */
}

.burger-icon {
    position: absolute; /* Position it absolutely within the appbar */
    top: 34px;
    left: 27px; /* Position it 10px from the left edge */
    width: 40px; /* Adjust icon size as needed */
    height: auto;
}

.appbar img {
    max-width: 100%;
    height: auto;
}


a {
    text-decoration: none;
}




.container {
    padding: 16px;
    padding-top: 80px; /* Height of the appbar + additional padding */
    overflow-y: auto; /* Enable vertical scrolling for content */
}
        .header {
            font-size: 22px;
            font-weight: bold;
            margin-top: 16%;
            margin-bottom: 2px;
            font-family: 'RidleyGroteskBold';
        }

        .subheader {
            font-size: 14px;
            color: grey;
            margin-top: 4px;
            margin-bottom: 6px;
            font-family: 'RidleyGroteskRegular';
        }
        .subheaderـar {
            font-size: 14px;
            color: grey;
            margin-bottom: 16px;
            font-family: 'HacenMaghrebRegular';
        }

        .arabic-text {
            font-family: 'HacenMaghrebBold';
            font-size: 21px;
        }

        .arabic-text-button {
            font-family: 'HacenMaghrebBold';
            font-size: 16px;
        }

        .english-text {
            font-family: 'RidleyGroteskBold';
        }
        .card {
            background-color: white;
            border-radius: 13px;
            box-shadow: -2px 3px 20px rgba(0, 0, 0, 0.16);
            padding: 20px 16px;
            margin-bottom: 16px;
            font-family: 'RidleyGroteskMedium';
        }
        .input-field {
        width: 92%;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid transparent; /* Set initial border as transparent */
        padding-top: 16px;
        padding-bottom: 32px;
        padding-left: 16px;
        margin-right: 18px;
        margin-bottom: 16px;
        font-family: 'RidleyGroteskRegular';
        font-size: 16px;
        background-color: white;
        border-radius: 13px;
        box-shadow: -2px 3px 20px rgba(0, 0, 0, 0.16);
            outline: none; /* Remove browser default outline */

        transition: border-color 0.2s ease; /* Smooth transition for border color change */
    }

    .input-field::selection {
    outline: none; /* Remove browser default outline */
    border: 2px solid #2667ff;
    }
    .input-field::highlight {
     outline: none; /* Remove browser default outline */
    border: 2px solid #2667ff;
    }
    .input-field:focus {
    outline: none; /* Remove browser default outline */
    border: 2px solid #2667ff;
}
        .button {
            display: block;
            width: 100%;
            padding: 32px;
            background-color: #2667ff;
            color: white;
            margin-bottom: 40px;
            border: none;
            border-radius: 22px;
            font-weight: bold;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
            font-family: 'RidleyGroteskBold';
        }
        .button:disabled {
            background-color: #2667ff;
            cursor: not-allowed;
            color: white;
            font-size: 16px;
        }
        .plate-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .plate {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 24px;
        }
        .spinner {
            width: 30px;
            height: 30px;
            animation: rotate 2s linear infinite;
            display: none; /* Initially hide the spinner */
        }

        .path {
            stroke: white;
            stroke-linecap: round;
            animation: dash 1.5s ease-in-out infinite;
        }

        @keyframes rotate {
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes dash {
            0% {
                stroke-dasharray: 1, 150;
                stroke-dashoffset: 0;
            }
            50% {
                stroke-dasharray: 90, 150;
                stroke-dashoffset: -35;
            }
            100% {
                stroke-dasharray: 90, 150;
                stroke-dashoffset: -124;
            }
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
<script type="module">
  let encryptedCode = null;    // holds the “SignalCode” param
  let foundCar = null;         // will store the car object returned by /get_car
  let isSignalActive = false;  // tracks whether we can send a signal

  //─────────────────────────────────────────────────────────────────────────
  function getUrlParameter(name) {
    name = name.replace(/[\[\]]/g, '\\$&');
    const regex = new RegExp('[?&]' + name + '(?:=([^&#]*)|&|#|$)');
    const results = regex.exec(window.location.href);
    if (!results) return null;
    if (!results[1]) return '';

    // DecodeURIComponent to handle URL decoding
    return decodeURIComponent(results[1].replace(' ', /\+/g));
}

  //─────────────────────────────────────────────────────────────────────────
  async function getCarByID(encryptedCode) {
    try {
      const resp = await fetch('https://signals-api-xi.vercel.app/get_car', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ encryptedCode }),
      });
      if (!resp.ok) {
        console.error('get_car returned status', resp.status);
        alert('Car not found or invalid SignalCode.');
        return;
      }
      const carData = await resp.json();
      /*
        carData has:
          {
            carDocId: "...",
            brand: "...",
            model: "...",
            licenseNumber: "...",
            licensePlate: "...",
            color: "0xFFaabbcc",
            signalActive: true|false,
            brandImage: "... or null"
          }
      */
      foundCar = carData;
      displayCarInfo();
    } catch (e) {
      console.error('Network error in getCarByID:', e);
      alert('Unable to fetch car info.');
    }
  }

  //─────────────────────────────────────────────────────────────────────────
  function displayCarInfo() {
    const carBrandElement   = document.getElementById('car-brand-card');
    const carModelElement   = document.getElementById('car-model-card');
    const licenseNumberElem = document.getElementById('license-number');
    const licensePlateElem  = document.getElementById('license-plate');
    const sendButton        = document.getElementById('send-button');

    if (
      !carBrandElement ||
      !carModelElement ||
      !licenseNumberElem ||
      !licensePlateElem ||
      !sendButton
    ) {
      console.error('One or more required elements not found.');
      return;
    }

    // Populate fields from foundCar
    carBrandElement.innerText   = foundCar.brand;
    carModelElement.innerText   = foundCar.model;
    licenseNumberElem.innerText = foundCar.licenseNumber;
    licensePlateElem.innerText  = foundCar.licensePlate;

    if (typeof foundCar.color === "string") {
  let raw = foundCar.color;

  // Case 1: starts with "0x" and is 10 chars long (e.g. "0xFFaabbcc")
  if (raw.startsWith("0x") && raw.length === 10) {
    // skip "0xFF", keep the last 6 chars
    raw = raw.slice(4); 
  }
  // Case 2: exactly 8 hex chars (e.g. "ffFFBE01")
  else if (/^[0-9A-Fa-f]{8}$/.test(raw)) {
    // skip the first 2 chars (alpha), keep the last 6
    raw = raw.slice(2);
  }
  // Otherwise, fall back to using the entire string (may not be a valid 6-digit color)
  
  // Now `raw` should be exactly 6 hex digits (e.g. "aabbcc" or "FFBE01")
  document
    .getElementById("send-button")
    .style.setProperty("background-color", `#${raw}`);
}


    // Enable or disable the Send button based on signalActive
    if (foundCar.signalActive === true) {
      isSignalActive = true;
      sendButton.disabled = false;
      console.log(`Signal is Active for ${foundCar.brand} ${foundCar.model}`);
    } else {
      isSignalActive = false;
      sendButton.disabled = true;
      console.log(`Signal is NOT Active for ${foundCar.brand} ${foundCar.model}`);
      alert(`Signals are not active for this ${foundCar.brand} / صاحب المركبة مفعلش الكود`);
    }
  }

  //─────────────────────────────────────────────────────────────────────────
  async function sendSignal(encryptedCode) {
    if (!foundCar) {
      alert('No car selected.');
      return;
    }

    const messageTextarea = document.getElementById('message');
    const message = messageTextarea.value.trim();
    if (!message) {
      alert('Your message is empty.');
      return;
    }

    if (!isSignalActive) {
      alert(`Cannot send: signal not active for this ${foundCar.brand}.`);
      return;
    }

    const sendButton = document.getElementById('send-button');
    const spinner    = document.querySelector('.spinner');

    // Disable UI while request is in flight
    sendButton.disabled = true;
    spinner.style.display = 'inline-block';
    sendButton.querySelector('.english-text').style.display = 'none';
    sendButton.querySelector('.arabic-text-button').style.display = 'none';

    try {
      const resp = await fetch('https://signals-api-xi.vercel.app/send_signal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ encryptedCode, message }),
      });
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        alert(err.error || 'Error sending signal');
      } else {
        const result = await resp.json();
        console.log('Signal sent:', result.signalID);
        alert('Owner has been notified / تم إخطار صاحب المركبة');
        messageTextarea.value = '';
      }
    } catch (e) {
      console.error('Network error in sendSignal:', e);
      alert('Unable to send signal.');
    } finally {
      // Re‐enable UI
      sendButton.disabled = false;
      spinner.style.display = 'none';
      sendButton.querySelector('.english-text').style.display = 'inline';
      sendButton.querySelector('.arabic-text-button').style.display = 'inline';
    }
  }

  //─────────────────────────────────────────────────────────────────────────
  document.addEventListener('DOMContentLoaded', (event) => {
    encryptedCode = getUrlParameter('SignalCode');
    if (!encryptedCode) {
      console.error('No SignalCode in URL.');
      alert('Invalid SignalCode parameter.');
      return;
    }

    // Fetch car details (backend will decrypt & look up Firestore)
    getCarByID(encryptedCode);

    // Attach click handler: when clicked, pass encryptedCode so backend can re‐decrypt
    const sendButton = document.getElementById('send-button');
    sendButton.addEventListener('click', () => sendSignal(encryptedCode));
  });
</script>




</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K67483K"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <!-- Appbar -->
    <div class="appbar">
        <a href="https://drop-eg.com/side-menu">
        <img src="assets/Burger.png" alt="Burger Icon" class="burger-icon">
    </a>
        <img src="assets/DHeader.png" alt="Appbar Image">
    </div>

    <div class="container">
        <!-- Your content here -->
        <div class="header">Send a Signal / <span class="arabic-text">إبعت إشارة</span></div>
        <div class="subheader">Message the owner of this vehicle</div>
        <div class="subheaderـar">ابعت رسالة لصاحب المركبة</div>
        <div class="card" id="car-brand-card"></div>
        <div class="card" id="car-model-card"></div>

        <!-- License Number and Plate with Images -->
        <div style="position: relative; width: 100%;">
            <div style="position: relative; width: 100%; margin-top: 16px; margin-bottom: 16px; border-radius: 13px; overflow: hidden; box-shadow: -2px 3px 20px rgba(0, 0, 0, 0.16);">
                <img src="assets/EgyptPlates.png" alt="Egypt Plates" style="width: 100%; display: block;">
                <div id="license-number" class="plate" style="position: absolute; left: 0%; top: 40%; width: 50%; height: 60px; display: flex; justify-content: center; align-items: center; font-family: 'RidleyGroteskBold';">
                    <!-- Dynamic text loaded here -->
                </div>
                <div id="license-plate" class="plate" style="position: absolute; left: 55%; top: 40%; width: 43%; height: 60px; display: flex; justify-content: center; align-items: center; font-family: 'RidleyGroteskBold';">
                    <!-- Dynamic text loaded here -->
                </div>
            </div>
        </div>

        <textarea id="message" class="input-field" rows="3" placeholder="Your message to the vehicle owner..................................رسالتك لصاحب المركبة"></textarea>
        <button id="send-button" class="button" disabled>
            <span class="text-container">
                <span class="english-text">Send Signal / </span>
                <span class="arabic-text-button">ابعت الإشارة</span>
                <svg class="spinner" viewBox="0 0 50 50">
                    <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="10"></circle>
                </svg>
            </span>
        </button>
        <a href="https://drop-eg.com/download" target="_blank" rel="noopener noreferrer">
    <button id="download-button" class="button">
        <span class="text-container">
            <span class="english-text">Need a Similar Code? / </span>
            <br>
            <span class="arabic-text-button">عايز كود زي دة؟</span>
        </span>
    </button>
</a>

            </div>
</body>
</html>
